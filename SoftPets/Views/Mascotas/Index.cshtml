@model IEnumerable<SoftPets.Models.Mascota>
@{
    int? rolId = Session["RolId"] as int?;
    ViewBag.Title = (rolId == 1 || rolId == 3) ? "Mascotas" : "Mis Mascotas";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var razas = ViewBag.Razas as List<string>;
    var sexos = ViewBag.Sexos as List<string>;
    var duenios = ViewBag.Duenios as List<SoftPets.Models.Duenio>;
}

<div class="main-content-bg">
    <div class="tabla-container">
        <h2 class="text-center mb-4">@ViewBag.Title</h2>
        <p class="text-center">
            @Html.ActionLink("Registrar Mascota", "Create", null, new { @class = "btn btn-unificado btn-crear-nuevo mb-3" })
        </p>
        <div class="mb-3 d-flex justify-content-center align-items-center flex-wrap gap-2">
            <input type="text" id="filtroMascota" class="form-control" style="max-width:240px;" placeholder="Buscar por nombre de mascota..." />
            @if (rolId == 1 || rolId == 3)
            {
                <input type="text" id="filtroDuenio" class="form-control" style="max-width:170px;" placeholder="Buscar por dueño..." />
                <select id="filtroSexo" class="form-control" style="max-width:130px;">
                    <option value="">Sexo</option>
                    @foreach (var s in sexos)
                    {
                        <option value="@s">@s</option>
                    }
                </select>
                <select id="filtroRaza" class="form-control" style="max-width:170px;">
                    <option value="">Raza</option>
                    @foreach (var r in razas)
                    {
                        <option value="@r">@r</option>
                    }
                </select>
            }
            <button type="button" id="btnLimpiarFiltros" class="btn btn-unificado btn-sm" title="Limpiar filtros" style="height:38px;">
                <i class="bi bi-x-circle"></i>
            </button>
        </div>
        <table class="table table-custom" id="tablaMascotas">
            <tr>
                @if (rolId == 1 || rolId == 3)
                {
                    <th>Dueño</th>
                }
                <th>Mascota</th>
                <th>Raza</th>
                <th>Sexo</th>
                <th>Fecha Nac.</th>
                <th>Foto</th>
                <th>Acciones</th>
            </tr>
            @foreach (var item in Model)
            {
                <tr>
                    @if (rolId == 1 || rolId == 3)
                    {
                        <td>@($"{item.DueñoNombre} {item.DueñoApellido}")</td>
                    }
                    <td>@item.Nombre</td>
                    <td>@item.Raza</td>
                    <td>
                        @if (item.Sexo == "Macho")
                        {
                            @:<i class="bi bi-gender-male" style="color:#2563eb;font-size:1.2em;" title="Macho"></i> Macho
                        }
                        else if (item.Sexo == "Hembra")
                        {
                            @:<i class="bi bi-gender-female" style="color:#f472b6;font-size:1.2em;" title="Hembra"></i> Hembra
                        }
                        else
                        {
                            @item.Sexo
                        }
                    </td>
                    <td>@(item.FechaNacimiento.HasValue ? item.FechaNacimiento.Value.ToString("dd/MM/yyyy") : "")</td>
                    <td>
                        @if (!string.IsNullOrEmpty(item.Foto))
                        {
                            <button type="button"
                                    class="btn btn-unificado btn-sm"
                                    title="Ver foto"
                                    onclick="mostrarFoto('@item.Foto', '@item.Nombre')">
                                <i class="bi bi-eye"></i>
                            </button>
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td>
                        <div class="acciones-btn-group" style="margin-bottom:6px;">
                            <a href="javascript:void(0);" class="btn btn-unificado btn-sm" title="Detalles"
                               onclick="mostrarDetallesMascota('@item.Nombre', '@item.Especie', '@item.Raza', '@item.Sexo', '@item.Color', '@(item.FechaNacimiento.HasValue ? item.FechaNacimiento.Value.ToString("dd/MM/yyyy") : "")', '@item.Renian', '@item.Foto')">
                                <i class="bi bi-info-circle"></i>
                            </a>
                            <a href="@Url.Action("Edit", new { id = item.Id })" class="btn btn-unificado btn-sm" title="Editar">
                                <i class="bi bi-pencil-square"></i>
                            </a>
                        </div>
                        <div class="acciones-btn-group">
                            @*<a href="@Url.Action("Index", "Vacunaciones", new { mascotaId = item.Id })" class="btn btn-unificado btn-sm" title="Vacunas">
                                <i class="bi bi-capsule"></i>
                            </a>*@
                            <a href="@Url.Action("Index", "Vacunaciones", new { mascotaId = item.Id })" class="btn btn-unificado btn-sm" title="Vacunaciones/Pastillas">
                                <i class="bi bi-shield-plus"></i>
                            </a>
                            <a href="@Url.Action("Index", "Tendencias", new { mascotaId = item.Id })" class="btn btn-unificado btn-sm" title="Tendencias">
                                <i class="bi bi-bar-chart-line"></i>
                            </a>
                            <a href="@Url.Action("IndexConsultaPorMascota", "HistorialClinico", new { mascotaId = item.Id })" class="btn btn-unificado btn-sm" title="Historial Consulta">
                                <i class="bi bi-journal-text"></i>
                            </a>
                            <a href="@Url.Action("IndexEmergenciaPorMascota", "HistorialClinico", new { mascotaId = item.Id })" class="btn btn-unificado btn-sm" title="Historial Emergencia">
                                <i class="bi bi-exclamation-triangle"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            }
        </table>
    </div>
</div>

<!-- Modal para mostrar la foto -->
<div class="modal fade" id="fotoModal" tabindex="-1" aria-labelledby="fotoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fotoModalLabel">Foto de <span id="nombreMascotaFoto"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <img id="fotoMascota" src="" alt="Foto Mascota" style="max-width:100%;max-height:350px;border-radius:12px;box-shadow:0 2px 12px rgba(44,62,80,0.12);" />
            </div>
        </div>
    </div>
</div>

<!-- Modal de detalles de mascota -->
<div class="modal fade" id="detallesMascotaModal" tabindex="-1" aria-labelledby="detallesMascotaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detallesMascotaModalLabel">Detalles de la Mascota</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="detallesMascotaBody">
                <!-- Aquí se llenará dinámicamente -->
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    var rolId = @((int?)rolId ?? 0);

    function mostrarFoto(ruta, nombre) {
        var modal = new bootstrap.Modal(document.getElementById('fotoModal'));
        document.getElementById('fotoMascota').src = ruta;
        document.getElementById('nombreMascotaFoto').innerText = nombre;
        modal.show();
    }

    function mostrarDetallesMascota(nombre, especie, raza, sexo, color, fechaNac, renian, foto) {
        var html = '';
        html += `<div class="row mb-2"><div class="col-5 modal-details-label">Nombre:</div><div class="col-7 modal-details-value">${nombre}</div></div>`;
        html += `<div class="row mb-2"><div class="col-5 modal-details-label">Especie:</div><div class="col-7 modal-details-value">${especie}</div></div>`;
        html += `<div class="row mb-2"><div class="col-5 modal-details-label">Raza:</div><div class="col-7 modal-details-value">${raza}</div></div>`;
        html += `<div class="row mb-2"><div class="col-5 modal-details-label">Sexo:</div><div class="col-7 modal-details-value">${sexo}</div></div>`;
        html += `<div class="row mb-2"><div class="col-5 modal-details-label">Color:</div><div class="col-7 modal-details-value">${color}</div></div>`;
        html += `<div class="row mb-2"><div class="col-5 modal-details-label">Fecha Nac.:</div><div class="col-7 modal-details-value">${fechaNac}</div></div>`;
        html += `<div class="row mb-2"><div class="col-5 modal-details-label">Renian:</div><div class="col-7 modal-details-value">${renian || '-'}</div></div>`;
        if (foto) {
            html += `<div class="row mb-2"><div class="col-12 text-center"><img src="${foto}" alt="Foto Mascota" style="max-width:160px;max-height:160px;border-radius:12px;box-shadow:0 2px 12px rgba(44,62,80,0.12);" /></div></div>`;
        }
        document.getElementById('detallesMascotaBody').innerHTML = html;
        var modal = new bootstrap.Modal(document.getElementById('detallesMascotaModal'));
        modal.show();
    }

    // Buscador por nombre, sexo, raza y dueño
    document.getElementById('filtroMascota').addEventListener('keyup', filtrarMascotas);
    var filtroSexo = document.getElementById('filtroSexo');
    var filtroRaza = document.getElementById('filtroRaza');
    var filtroDuenio = document.getElementById('filtroDuenio');
    if (filtroSexo) filtroSexo.addEventListener('change', filtrarMascotas);
    if (filtroRaza) filtroRaza.addEventListener('change', filtrarMascotas);
    if (filtroDuenio) filtroDuenio.addEventListener('keyup', filtrarMascotas);

    // Botón limpiar filtros
    document.getElementById('btnLimpiarFiltros').onclick = function () {
        if (filtroDuenio) filtroDuenio.value = '';
        document.getElementById('filtroMascota').value = '';
        if (filtroSexo) filtroSexo.selectedIndex = 0;
        if (filtroRaza) filtroRaza.selectedIndex = 0;
        filtrarMascotas();
    };

    function filtrarMascotas() {
        var filtro = document.getElementById('filtroMascota').value.toLowerCase();
        var sexo = filtroSexo ? filtroSexo.value.toLowerCase() : '';
        var raza = filtroRaza ? filtroRaza.value.toLowerCase() : '';
        var duenio = filtroDuenio ? filtroDuenio.value.toLowerCase() : '';
        var filas = document.querySelectorAll('#tablaMascotas tbody tr');
        filas.forEach(function (fila) {
            var tds = fila.querySelectorAll('td');
            if (tds.length < (rolId == 1 || rolId == 3 ? 7 : 6)) return;
            var idxNombre = (rolId == 1 || rolId == 3) ? 1 : 0;
            var idxRaza = (rolId == 1 || rolId == 3) ? 2 : 1;
            var idxSexo = (rolId == 1 || rolId == 3) ? 3 : 2;
            var idxDuenio = (rolId == 1 || rolId == 3) ? 0 : -1;

            var nombre = tds[idxNombre].innerText.toLowerCase();
            var razaTd = tds[idxRaza].innerText.toLowerCase();
            var sexoTd = tds[idxSexo].innerText.toLowerCase();
            var sexoLimpio = sexoTd.replace(/[^a-zA-Z]/g, '').trim();
            var duenioTd = idxDuenio >= 0 ? tds[idxDuenio].innerText.toLowerCase().trim() : '';

            var mostrar = true;
            if (filtro && nombre.indexOf(filtro) === -1) mostrar = false;
            if (sexo && sexoLimpio !== sexo) mostrar = false;
            if (raza && razaTd !== raza) mostrar = false;
            if ((rolId == 1 || rolId == 3) && duenio && duenioTd.indexOf(duenio) === -1) mostrar = false;
            fila.style.display = mostrar ? '' : 'none';
        });
    }

     @if (TempData["SwalMascotaCreada"] != null)
        {
            <text>
            Swal.fire({
                icon: 'success',
                title: '¡Mascota creada!',
                text: 'La mascota "@Html.Raw(TempData["SwalMascotaCreada"].ToString())" fue creada correctamente.',
                showConfirmButton: false,
                timer: 1800
            });
            </text>
        }
@if (TempData["SwalMascotaEditada"] != null)
{
            <text>

        Swal.fire({
            icon: 'success',
            title: '¡Mascota actualizada!',
            text: 'La mascota "@Html.Raw(TempData["SwalMascotaEditada"].ToString())" fue actualizada correctamente.',
            showConfirmButton: false,
            timer: 1800
        });
            </text>
}

</script>
