@model IEnumerable<SoftPets.Models.HistorialClinico>
@{
    ViewBag.Title = "Historial Emergencia - Mascota";
    Layout = "~/Views/Shared/_Layout.cshtml";
    int mascotaId = ViewBag.MascotaId;
    string nombreMascota = ViewBag.NombreMascota;
}

<div class="main-content-bg">
    <div class="tabla-container">
        <h2 class="text-center mb-4">Historial de Emergencias de @nombreMascota</h2>
        <div class="text-center mb-3">
            <button class="btn btn-unificado btn-sm me-2" onclick="filtrarConsultas('proceso')">Emergencias en Proceso</button>
            <button class="btn btn-unificado btn-sm me-2" onclick="filtrarConsultas('finalizado')">Emergencias Finalizadas</button>
            <button class="btn btn-unificado btn-sm" onclick="filtrarConsultas('')">Todas</button>
        </div>
        <p class="text-center">
            @Html.ActionLink("Registrar Emergencia", "Create", new { mascotaId = mascotaId, tipo = "Emergencia" }, new { @class = "btn btn-unificado btn-crear-nuevo mb-3" })
        </p>
        <div id="tablaConsultas">
            <table class="table table-custom">
                <tr>
                    <th>Motivo</th>
                    <th>Fecha Inicio</th>
                    <th>Fecha Posible Fin</th>
                    <th>Fecha Final</th>
                    <th>Acciones</th>
                </tr>
                @foreach (var item in Model)
                {
                    var estado = item.FechaFinTratamiento.HasValue ? "finalizado" : "proceso";
                    <tr data-estado="@estado">
                        <td>@item.Motivo</td>
                        <td>@item.FechaInicioTratamiento.ToString("dd/MM/yyyy")</td>
                        <td>@item.FechaPosibleFinTratamiento.ToString("dd/MM/yyyy")</td>
                        <td>@(item.FechaFinTratamiento.HasValue ? item.FechaFinTratamiento.Value.ToString("dd/MM/yyyy") : "-")</td>
                        <td>
                            <div class="acciones-btn-group" style="margin-bottom:6px;">
                                @{
                                    var isFinalizado = item.FechaFinTratamiento.HasValue;
                                    var tooltip = isFinalizado ? "Edición deshabilitada: emergencia finalizada" : "Editar";
                                }
                                @if (isFinalizado)
                                {
                                    <span class="btn btn-unificado btn-sm disabled"
                                          title="@tooltip"
                                          style="cursor: not-allowed; display: inline-block;"
                                          tabindex="-1" aria-disabled="true">
                                        <i class="bi bi-pencil-square"></i>
                                    </span>
                                }
                                else
                                {
                                    <a href="@Url.Action("Edit", new { id = item.Id })"
                                       class="btn btn-unificado btn-sm"
                                       title="@tooltip">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                }
                            </div>
                            <div class="acciones-btn-group">
                                <a href="@Url.Action("Index", "DetalleHistorialClinico", new { historialClinicoId = item.Id })" class="btn btn-unificado btn-sm" title="Ver Diagnóstico">
                                    <i class="bi bi-clipboard2-pulse"></i>
                                </a>
                            </div>
                            @if (!item.FechaFinTratamiento.HasValue)
                            {
                                <div class="acciones-btn-group" style="margin-top:8px;">
                                    <button class="btn btn-unificado btn-sm" title="Dar de alta" onclick="cerrarHistorial(@item.Id)">
                                        <i class="bi bi-check-circle" style="color:#22c55e;"></i>
                                    </button>
                                </div>
                            }
                        </td>
                    </tr>
                }
            </table>
        </div>
    </div>
</div>
<div class="modal fade" id="detallesHistorialClinicoModal" tabindex="-1" aria-labelledby="detallesHistorialClinicoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detallesHistorialClinicoModalLabel">Detalles de Historial Clínico</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="detallesHistorialClinicoBody">
                <!-- Aquí se llenará dinámicamente -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
function filtrarConsultas(estado) {
    $("#tablaConsultas tr[data-estado]").each(function () {
        var fila = $(this);
        if (estado === "") {
            fila.show();
        } else if (fila.data("estado") === estado) {
            fila.show();
        } else {
            fila.hide();
        }
    });
}

function cerrarHistorial(id) {
    Swal.fire({
        title: '¿Está seguro?',
        text: '¿Desea cerrar esta emergencia?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sí, cerrar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            $.post('@Url.Action("CerrarHistorial", "HistorialClinico")', { id: id }, function (res) {
                if (res.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Emergencia cerrada!',
                        showConfirmButton: false,
                        timer: 1200
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo cerrar la emergencia.',
                        showConfirmButton: true
                    });
                }
            });
        }
    });
}
    </script>
    @if (TempData["SwalMascotaEditada"] != null)
    {
        <text>
            Swal.fire({
            icon: 'success',
            title: '¡Operación exitosa!',
            text: '@Html.Raw(TempData["SwalMascotaEditada"].ToString())',
            showConfirmButton: false,
            timer: 1800
            });
        </text>
    }
    @if (TempData["SwalError"] != null)
    {
        <text>
            Swal.fire({
            icon: 'error',
            title: '¡Error!',
            text: '@Html.Raw(TempData["SwalError"].ToString())',
            showConfirmButton: true
            });
        </text>
    }
}