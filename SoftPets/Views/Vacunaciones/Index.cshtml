@model IEnumerable<SoftPets.Models.Vacunacion>
@{
    ViewBag.Title = "Vacunaciones y Pastillas";
    Layout = "~/Views/Shared/_Layout.cshtml";

    int mascotaId = ViewBag.MascotaId;
    string tipo = ViewBag.Tipo as string ?? "";
    string estado = ViewBag.Estado as string ?? "";
    var vacunasNombres = ViewBag.VacunasNombres as Dictionary<int, string>; // Si lo usas para mostrar nombre en vez de ID
}

<div class="main-content-bg">
    <div class="tabla-container" style="overflow-x:auto; min-width:1100px;">
        <h2 class="text-center mb-4">Vacunaciones y Pastillas de la Mascota</h2>
        <form id="filtroForm" class="row mb-3 g-2 justify-content-center">
            <div class="col-auto">
                <select name="tipo" class="form-select">
                    <option value="">-- Tipo --</option>
                    <option value="Vacuna" @(tipo == "Vacuna" ? "selected" : "")>Vacuna</option>
                    <option value="Pastilla" @(tipo == "Pastilla" ? "selected" : "")>Pastilla</option>
                </select>
            </div>
            <div class="col-auto">
                <select name="estado" class="form-select">
                    <option value="">-- Estado --</option>
                    <option value="Pendiente" @(estado == "Pendiente" ? "selected" : "")>Pendiente</option>
                    <option value="Aplicada" @(estado == "Aplicada" ? "selected" : "")>Aplicada</option>
                </select>
            </div>
            <div class="col-auto align-self-end">
                @Html.ActionLink("Registrar Vacunación/Pastilla", "Create", new { mascotaId = mascotaId }, new { @class = "btn btn-unificado btn-crear-nuevo mb-3" })
            </div>
        </form>
        <div id="tablaVacunaciones">
            <table class="table table-custom" style="min-width:1000px;">
                <tr>
                    <th>Vacuna/Pastilla</th>
                    <th>Dosis Aplicada</th>
                    <th>Fecha Aplicada</th>
                    <th>Fecha Programada</th>
                    <th>Lote</th>
                    <th>Estado</th>
                    <th>Observaciones</th>
                    <th>Acciones</th>
                </tr>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            @(
                                vacunasNombres != null && vacunasNombres.ContainsKey(item.VacunaId)
                                ? vacunasNombres[item.VacunaId]
                                : item.VacunaId.ToString()
                            )
                        </td>
                        <td>@item.DosisAplicada</td>
                        <td>@(item.FechaAplicada.HasValue ? item.FechaAplicada.Value.ToString("dd/MM/yyyy") : "-")</td>
                        <td>@(item.FechaProgramada.HasValue ? item.FechaProgramada.Value.ToString("dd/MM/yyyy") : "-")</td>
                        <td>@item.Lote</td>
                        <td>
                            @if (item.Estado == "Aplicada")
                            {
                                <span class="badge bg-success">Aplicada</span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark">Pendiente</span>
                            }
                        </td>
                        <td>@item.Observaciones</td>
                        <td>
                            <a href="@Url.Action("Edit", new { id = item.Id })" class="btn btn-unificado btn-sm" title="Editar">
                                <i class="bi bi-pencil-square"></i>
                            </a>
                        </td>
                    </tr>
                }
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
function cargarTablaVacunaciones() {
    var data = $("#filtroForm").serialize();
    $.get('@Url.Action("Index", "Vacunaciones")', data + "&mascotaId=@mascotaId", function (html) {
        var newTable = $(html).find("#tablaVacunaciones").html();
        $("#tablaVacunaciones").html(newTable);
    });
}
$('#filtroForm select').on('change', function () {
    cargarTablaVacunaciones();
});
    </script>
}